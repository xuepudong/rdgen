name: Test Certificate and Password
run-name: Test Certificate and Password

on:
  workflow_dispatch:

jobs:
  test-cert:
    name: Test Certificate Password
    runs-on: macos-latest

    steps:
      - name: Install rcodesign tool
        shell: bash
        run: |
          pushd /tmp
          wget https://github.com/indygreg/apple-platform-rs/releases/download/apple-codesign%2F0.22.0/apple-codesign-0.22.0-macos-universal.tar.gz
          tar -zxvf apple-codesign-0.22.0-macos-universal.tar.gz
          sudo mv apple-codesign-0.22.0-macos-universal/rcodesign /usr/local/bin
          popd

      - name: Verify rcodesign installation
        run: |
          which rcodesign
          rcodesign --version

      - name: Test rcodesign syntax
        run: |
          echo "=== Testing rcodesign help ==="
          rcodesign --help
          echo ""
          echo "=== Testing rcodesign sign help ==="
          rcodesign sign --help

      - name: Test certificate decoding and password
        run: |
          echo "=== Step 1: Decode certificate ==="
          if [ -z "${{ secrets.MACOS_P12_BASE64 }}" ]; then
            echo "ERROR: MACOS_P12_BASE64 secret is not set!"
            exit 1
          fi

          echo "Certificate base64 length: ${#MACOS_P12_BASE64}"
          echo "${{ secrets.MACOS_P12_BASE64 }}" | base64 --decode > test_certificate.p12

          if [ ! -f test_certificate.p12 ]; then
            echo "ERROR: Failed to create certificate file!"
            exit 1
          fi

          echo "Certificate file size: $(ls -lh test_certificate.p12 | awk '{print $5}')"
          echo "Certificate file type: $(file test_certificate.p12)"

          echo ""
          echo "=== Step 2: Check password secret ==="
          if [ -z "${{ secrets.MACOS_P12_PASSWORD }}" ]; then
            echo "ERROR: MACOS_P12_PASSWORD secret is not set!"
            exit 1
          fi

          echo "Password is set (length: ${#MACOS_P12_PASSWORD} characters)"

          echo ""
          echo "=== Step 3: Create password file ==="
          echo "${{ secrets.MACOS_P12_PASSWORD }}" > .p12_password
          echo "Password file created"
          echo "Password file size: $(wc -c < .p12_password) bytes"

          # Check for hidden characters
          echo "Password file hex dump (first 100 bytes):"
          xxd -l 100 .p12_password || hexdump -C .p12_password | head -5

          # Try without newline
          echo -n "${{ secrets.MACOS_P12_PASSWORD }}" > .p12_password_no_newline
          echo "Password file without newline size: $(wc -c < .p12_password_no_newline) bytes"

          echo ""
          echo "=== Step 4: Test with rcodesign ==="
          echo "Attempting to extract certificate info..."

          # Try with password file (with newline)
          echo "Test 1: Using password file with newline..."
          if rcodesign extract --p12-file test_certificate.p12 --p12-password-file .p12_password 2>&1; then
            echo "✅ SUCCESS: Certificate and password are valid (with newline)!"
          else
            echo "❌ FAILED: Password file with newline failed"
          fi

          # Try with password file (without newline)
          echo ""
          echo "Test 2: Using password file without newline..."
          if rcodesign extract --p12-file test_certificate.p12 --p12-password-file .p12_password_no_newline 2>&1; then
            echo "✅ SUCCESS: Certificate and password are valid (without newline)!"
          else
            echo "❌ FAILED: Password file without newline failed"
          fi

          # Try with password on command line
          echo ""
          echo "Test 3: Using inline password..."
          if rcodesign extract --p12-file test_certificate.p12 --p12-password "${{ secrets.MACOS_P12_PASSWORD }}" 2>&1; then
            echo "✅ SUCCESS: Inline password works!"
          else
            echo "❌ FAILED: Inline password failed"
          fi

          # Try with openssl
          echo ""
          echo "Test 4: Using OpenSSL..."
          if openssl pkcs12 -in test_certificate.p12 -passin pass:"${{ secrets.MACOS_P12_PASSWORD }}" -noout 2>&1; then
            echo "✅ SUCCESS: OpenSSL verification successful!"
          else
            echo "❌ FAILED: OpenSSL verification failed"
          fi

          # Try empty password
          echo ""
          echo "Test 5: Trying empty password..."
          if openssl pkcs12 -in test_certificate.p12 -passin pass: -noout 2>&1; then
            echo "⚠️  WARNING: Certificate has NO password!"
          else
            echo "Certificate is password protected (as expected)"
          fi

          # Clean up
          rm -f test_certificate.p12 .p12_password .p12_password_no_newline
