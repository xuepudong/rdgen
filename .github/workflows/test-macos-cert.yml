name: Test macOS Certificate

on:
  workflow_dispatch:

jobs:
  test-certificate:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test Certificate Decoding
        env:
          MACOS_P12_BASE64: ${{ secrets.MACOS_P12_BASE64 }}
          MACOS_P12_PASSWORD: ${{ secrets.MACOS_P12_PASSWORD }}
        run: |
          echo "=== Testing Certificate Secrets ==="

          # Check if secrets are set
          if [ -z "$MACOS_P12_BASE64" ]; then
            echo "❌ ERROR: MACOS_P12_BASE64 secret is not set!"
            exit 1
          else
            echo "✅ MACOS_P12_BASE64 secret is set"
            echo "   Length: ${#MACOS_P12_BASE64} characters"
          fi

          if [ -z "$MACOS_P12_PASSWORD" ]; then
            echo "❌ ERROR: MACOS_P12_PASSWORD secret is not set!"
            exit 1
          else
            echo "✅ MACOS_P12_PASSWORD secret is set"
            echo "   Length: ${#MACOS_P12_PASSWORD} characters"
          fi

          # Try to decode the certificate
          echo ""
          echo "=== Decoding Certificate ==="
          echo "$MACOS_P12_BASE64" | base64 --decode > test_certificate.p12

          if [ -f test_certificate.p12 ]; then
            FILE_SIZE=$(stat -f%z test_certificate.p12)
            echo "✅ Certificate decoded successfully"
            echo "   File size: $FILE_SIZE bytes"
          else
            echo "❌ ERROR: Failed to decode certificate"
            exit 1
          fi

          # Try to extract info using openssl
          echo ""
          echo "=== Testing Certificate with Password ==="
          if openssl pkcs12 -in test_certificate.p12 -passin pass:"$MACOS_P12_PASSWORD" -noout 2>/dev/null; then
            echo "✅ Certificate password is CORRECT!"
            echo ""
            echo "=== Certificate Details ==="
            openssl pkcs12 -in test_certificate.p12 -passin pass:"$MACOS_P12_PASSWORD" -nokeys -info 2>/dev/null | head -20 || true
          else
            echo "❌ ERROR: Certificate password is INCORRECT or certificate is invalid!"
            echo ""
            echo "Attempting to get more details..."
            openssl pkcs12 -in test_certificate.p12 -passin pass:"$MACOS_P12_PASSWORD" -noout 2>&1 | head -5 || true
            exit 1
          fi

          # Clean up
          rm -f test_certificate.p12

          echo ""
          echo "=== Test Summary ==="
          echo "✅ All tests passed!"
          echo "✅ MACOS_P12_BASE64 is correctly set in GitHub Secrets"
          echo "✅ MACOS_P12_PASSWORD is correctly set in GitHub Secrets"
          echo "✅ Certificate can be decoded and decrypted successfully"

      - name: Compare with Local Certificate (if available)
        if: always()
        run: |
          if [ -f "certs/certificate_base64.txt" ]; then
            echo "=== Comparing with Local Certificate ==="
            LOCAL_BASE64=$(cat certs/certificate_base64.txt)
            GITHUB_BASE64="${{ secrets.MACOS_P12_BASE64 }}"

            if [ "$LOCAL_BASE64" = "$GITHUB_BASE64" ]; then
              echo "✅ GitHub Secret matches local certificate file!"
            else
              echo "⚠️  WARNING: GitHub Secret differs from local certificate file"
              echo "   Local length: ${#LOCAL_BASE64}"
              echo "   GitHub length: ${#GITHUB_BASE64}"
            fi
          else
            echo "ℹ️  Local certificate file not found in repository"
          fi
