# macOS åº”ç”¨æœ¬åœ°ç­¾åå’Œå…¬è¯å®Œæ•´æµç¨‹

æœ¬æ–‡æ¡£æä¾›äº†åœ¨æœ¬åœ°å¯¹ macOS åº”ç”¨è¿›è¡Œç­¾åå’Œå…¬è¯çš„å®Œæ•´æ­¥éª¤ï¼Œç¡®ä¿åº”ç”¨å¯ä»¥åœ¨ç”¨æˆ·çš„ Mac ä¸Šç›´æ¥è¿è¡Œï¼Œä¸ä¼šå‡ºç°"ä¸å®‰å…¨"çš„è­¦å‘Šã€‚

## ğŸ“‹ å‰ææ¡ä»¶

- âœ… macOS ç³»ç»Ÿï¼ˆå¿…é¡»ï¼‰
- âœ… Apple Developer è´¦å·
- âœ… å·²å®‰è£… Xcode Command Line Tools
- âœ… æœ‰æ•ˆçš„ Developer ID Application è¯ä¹¦
- âœ… å·²æ„å»ºçš„åº”ç”¨ï¼ˆ.app æˆ– .dmgï¼‰

## ğŸ”‘ å‡†å¤‡å·¥ä½œ

### 1. ç”Ÿæˆ App-Specific Password

1. è®¿é—®ï¼šhttps://appleid.apple.com/
2. ç™»å½•ä½ çš„ Apple ID
3. è¿›å…¥"å®‰å…¨"éƒ¨åˆ†
4. ç‚¹å‡»"App-Specific Passwords"ï¼ˆåº”ç”¨ä¸“ç”¨å¯†ç ï¼‰
5. ç‚¹å‡»"Generate Password"
6. è¾“å…¥åç§°ï¼ˆä¾‹å¦‚ï¼š"Notarization"ï¼‰
7. **ä¿å­˜ç”Ÿæˆçš„å¯†ç **ï¼ˆæ ¼å¼ï¼šxxxx-xxxx-xxxx-xxxxï¼‰

### 2. è·å– Team ID

```bash
# æ–¹æ³• 1ï¼šä»è¯ä¹¦ä¸­è·å–
security find-identity -v -p codesigning

# æ–¹æ³• 2ï¼šä»å¼€å‘è€…ç½‘ç«™
# è®¿é—® https://developer.apple.com/account
# åœ¨å³ä¸Šè§’å¯ä»¥çœ‹åˆ° Team ID
```

ä½ çš„ Team IDï¼š**52MJ3RAU3G**

### 3. é…ç½® notarytoolï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰

```bash
# ä¿å­˜å‡­æ®åˆ° keychainï¼ˆé¿å…æ¯æ¬¡è¾“å…¥ï¼‰
xcrun notarytool store-credentials "Ruijie_Profile" \
  --apple-id "your@email.com" \
  --team-id "52MJ3RAU3G" \
  --password "xxxx-xxxx-xxxx-xxxx"
```

## ğŸ” æ­¥éª¤ 1ï¼šé‡æ–°ç­¾ååº”ç”¨ï¼ˆä¿®å¤è°ƒè¯•æƒé™é—®é¢˜ï¼‰

### 1.1 æŒ‚è½½ DMGï¼ˆå¦‚æœæ˜¯ DMG æ–‡ä»¶ï¼‰

```bash
# æŒ‚è½½ DMG
hdiutil attach Ruijie-SOS_MacOS-aarch64.dmg

# å¤åˆ¶åº”ç”¨åˆ°æœ¬åœ°
cp -R "/Volumes/ä½ çš„åº”ç”¨/å°é”äº‘æ¡¥(è¢«æ§ç«¯).app" ~/Desktop/
```

### 1.2 æ£€æŸ¥å½“å‰ç­¾å

```bash
# æ£€æŸ¥ç­¾åçŠ¶æ€
codesign -dvvv "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app"

# æ£€æŸ¥æƒé™ï¼ˆentitlementsï¼‰
codesign -d --entitlements - "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app"
```

### 1.3 ç§»é™¤æ—§ç­¾å

```bash
# ç§»é™¤åº”ç”¨çš„ç­¾å
codesign --remove-signature "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app"

# ç§»é™¤æ‰€æœ‰æ¡†æ¶çš„ç­¾å
find "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app/Contents/Frameworks" -name "*.framework" -exec codesign --remove-signature {} \;
find "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app/Contents/Frameworks" -name "*.dylib" -exec codesign --remove-signature {} \;
```

### 1.4 ä½¿ç”¨æ­£ç¡®çš„ entitlements é‡æ–°ç­¾å

```bash
# ç­¾åæ‰€æœ‰æ¡†æ¶å’Œåº“
find "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app/Contents/Frameworks" -name "*.framework" -exec \
  codesign --deep --force --sign "Developer ID Application: Beijing Yiyuan Information Technology Co., Ltd. (52MJ3RAU3G)" \
  --options runtime {} \;

find "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app/Contents/Frameworks" -name "*.dylib" -exec \
  codesign --force --sign "Developer ID Application: Beijing Yiyuan Information Technology Co., Ltd. (52MJ3RAU3G)" \
  --options runtime {} \;

# ç­¾åä¸»å¯æ‰§è¡Œæ–‡ä»¶
codesign --force --sign "Developer ID Application: Beijing Yiyuan Information Technology Co., Ltd. (52MJ3RAU3G)" \
  --options runtime \
  --entitlements entitlements.plist \
  "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app/Contents/MacOS/å°é”äº‘æ¡¥(è¢«æ§ç«¯)"

# ç­¾åæ•´ä¸ªåº”ç”¨åŒ…
codesign --deep --force --sign "Developer ID Application: Beijing Yiyuan Information Technology Co., Ltd. (52MJ3RAU3G)" \
  --options runtime \
  --entitlements entitlements.plist \
  "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app"
```

### 1.5 éªŒè¯ç­¾å

```bash
# éªŒè¯ç­¾å
codesign -vvv --deep --strict "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app"

# æ£€æŸ¥æ–°çš„æƒé™ï¼ˆåº”è¯¥ä¸åŒ…å« get-task-allowï¼‰
codesign -d --entitlements - "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app"

# éªŒè¯ Gatekeeper
spctl -a -vv "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app"
```

## ğŸ“¤ æ­¥éª¤ 2ï¼šå…¬è¯åº”ç”¨

### 2.1 åˆ›å»º ZIP æ–‡ä»¶

```bash
# åˆ›å»º ZIPï¼ˆApple è¦æ±‚çš„æ ¼å¼ï¼‰
ditto -c -k --keepParent "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app" "å°é”äº‘æ¡¥(è¢«æ§ç«¯).zip"
```

### 2.2 æäº¤å…¬è¯

```bash
# æ–¹æ³• 1ï¼šä½¿ç”¨ä¿å­˜çš„å‡­æ®
xcrun notarytool submit "å°é”äº‘æ¡¥(è¢«æ§ç«¯).zip" \
  --keychain-profile "Ruijie_Profile" \
  --wait

# æ–¹æ³• 2ï¼šç›´æ¥è¾“å…¥å‡­æ®
xcrun notarytool submit "å°é”äº‘æ¡¥(è¢«æ§ç«¯).zip" \
  --apple-id "your@email.com" \
  --password "xxxx-xxxx-xxxx-xxxx" \
  --team-id "52MJ3RAU3G" \
  --wait
```

**ç­‰å¾…æ—¶é—´ï¼š** é€šå¸¸ 1-5 åˆ†é’Ÿï¼Œé¦–æ¬¡å¯èƒ½éœ€è¦ 15 åˆ†é’Ÿ

### 2.3 æ£€æŸ¥å…¬è¯çŠ¶æ€

```bash
# å¦‚æœå…¬è¯æˆåŠŸï¼Œä¼šæ˜¾ç¤ºï¼š
# Successfully received submission info
# status: Accepted

# å¦‚æœå¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—
xcrun notarytool log <submission-id> --keychain-profile "Ruijie_Profile"
```

### 2.4 è£…è®¢å…¬è¯ç¥¨æ®

```bash
# è£…è®¢ç¥¨æ®åˆ°åº”ç”¨
xcrun stapler staple "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app"

# éªŒè¯è£…è®¢
xcrun stapler validate "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app"
```

## ğŸ“¦ æ­¥éª¤ 3ï¼šåˆ›å»ºåˆ†å‘ DMG

### 3.1 åˆ›å»º DMG

```bash
# å®‰è£… create-dmgï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
brew install create-dmg

# åˆ›å»º DMG
create-dmg \
  --volname "å°é”äº‘æ¡¥(è¢«æ§ç«¯)" \
  --window-pos 200 120 \
  --window-size 800 400 \
  --icon-size 100 \
  --icon "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app" 200 190 \
  --hide-extension "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app" \
  --app-drop-link 600 185 \
  "Ruijie-SOS_MacOS-aarch64-notarized.dmg" \
  "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app"
```

### 3.2 å…¬è¯ DMGï¼ˆå¯é€‰ä½†æ¨èï¼‰

```bash
# æäº¤ DMG å…¬è¯
xcrun notarytool submit "Ruijie-SOS_MacOS-aarch64-notarized.dmg" \
  --keychain-profile "Ruijie_Profile" \
  --wait

# è£…è®¢ç¥¨æ®åˆ° DMG
xcrun stapler staple "Ruijie-SOS_MacOS-aarch64-notarized.dmg"

# éªŒè¯
xcrun stapler validate "Ruijie-SOS_MacOS-aarch64-notarized.dmg"
```

## âœ… æ­¥éª¤ 4ï¼šéªŒè¯å’Œæµ‹è¯•

### 4.1 æœ€ç»ˆéªŒè¯

```bash
# éªŒè¯ç­¾å
codesign -vvv --deep --strict "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app"

# éªŒè¯å…¬è¯
spctl -a -vv "å°é”äº‘æ¡¥(è¢«æ§ç«¯).app"

# éªŒè¯ DMG
spctl -a -t open --context context:primary-signature -v "Ruijie-SOS_MacOS-aarch64-notarized.dmg"
```

### 4.2 æµ‹è¯•å®‰è£…

1. åŒå‡» DMG æ–‡ä»¶
2. æ‹–åŠ¨åº”ç”¨åˆ°"åº”ç”¨ç¨‹åº"æ–‡ä»¶å¤¹
3. æ‰“å¼€åº”ç”¨
4. **åº”è¯¥ç›´æ¥è¿è¡Œï¼Œä¸ä¼šå‡ºç°ä»»ä½•å®‰å…¨è­¦å‘Šï¼**

## ğŸ¯ å®Œæ•´è„šæœ¬ï¼ˆä¸€é”®æ‰§è¡Œï¼‰

åˆ›å»ºä¸€ä¸ª `sign-and-notarize.sh` è„šæœ¬ï¼š

```bash
#!/bin/bash

# é…ç½®
APP_NAME="å°é”äº‘æ¡¥(è¢«æ§ç«¯)"
TEAM_ID="52MJ3RAU3G"
CERT_NAME="Developer ID Application: Beijing Yiyuan Information Technology Co., Ltd. (52MJ3RAU3G)"
KEYCHAIN_PROFILE="Ruijie_Profile"

echo "ğŸ” å¼€å§‹ç­¾åå’Œå…¬è¯æµç¨‹..."

# 1. ç§»é™¤æ—§ç­¾å
echo "ğŸ“ ç§»é™¤æ—§ç­¾å..."
codesign --remove-signature "${APP_NAME}.app"

# 2. ç­¾åæ¡†æ¶
echo "ğŸ”§ ç­¾åæ¡†æ¶..."
find "${APP_NAME}.app/Contents/Frameworks" -name "*.framework" -exec \
  codesign --deep --force --sign "${CERT_NAME}" --options runtime {} \;

find "${APP_NAME}.app/Contents/Frameworks" -name "*.dylib" -exec \
  codesign --force --sign "${CERT_NAME}" --options runtime {} \;

# 3. ç­¾åä¸»åº”ç”¨
echo "âœï¸  ç­¾åä¸»åº”ç”¨..."
codesign --deep --force --sign "${CERT_NAME}" \
  --options runtime \
  --entitlements entitlements.plist \
  "${APP_NAME}.app"

# 4. éªŒè¯ç­¾å
echo "âœ… éªŒè¯ç­¾å..."
codesign -vvv --deep --strict "${APP_NAME}.app"

# 5. åˆ›å»º ZIP
echo "ğŸ“¦ åˆ›å»º ZIP..."
ditto -c -k --keepParent "${APP_NAME}.app" "${APP_NAME}.zip"

# 6. æäº¤å…¬è¯
echo "ğŸ“¤ æäº¤å…¬è¯..."
xcrun notarytool submit "${APP_NAME}.zip" \
  --keychain-profile "${KEYCHAIN_PROFILE}" \
  --wait

# 7. è£…è®¢ç¥¨æ®
echo "ğŸ“ è£…è®¢ç¥¨æ®..."
xcrun stapler staple "${APP_NAME}.app"

# 8. éªŒè¯
echo "ğŸ” éªŒè¯å…¬è¯..."
xcrun stapler validate "${APP_NAME}.app"

# 9. åˆ›å»º DMG
echo "ğŸ’¿ åˆ›å»º DMG..."
create-dmg \
  --volname "${APP_NAME}" \
  --window-pos 200 120 \
  --window-size 800 400 \
  --icon-size 100 \
  --app-drop-link 600 185 \
  "Ruijie-SOS_MacOS-notarized.dmg" \
  "${APP_NAME}.app"

echo "âœ… å®Œæˆï¼"
echo "ğŸ“¦ å·²åˆ›å»ºï¼šRuijie-SOS_MacOS-notarized.dmg"
```

ä½¿ç”¨æ–¹æ³•ï¼š

```bash
chmod +x sign-and-notarize.sh
./sign-and-notarize.sh
```

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: å…¬è¯å¤±è´¥ï¼Œæç¤º "get-task-allow" é”™è¯¯

**åŸå› ï¼š** åº”ç”¨åŒ…å«è°ƒè¯•æƒé™

**è§£å†³ï¼š** ä½¿ç”¨æœ¬æ–‡æ¡£çš„ entitlements.plist é‡æ–°ç­¾å

### Q2: ç­¾åååº”ç”¨æ— æ³•è¿è¡Œ

**åŸå› ï¼š** å¯èƒ½ç­¾åäº†é”™è¯¯çš„æ–‡ä»¶æˆ–æƒé™ä¸æ­£ç¡®

**è§£å†³ï¼š**
1. æ£€æŸ¥ entitlements.plist æ˜¯å¦æ­£ç¡®
2. ç¡®ä¿ä½¿ç”¨ `--deep` å‚æ•°ç­¾åæ‰€æœ‰ç»„ä»¶
3. éªŒè¯ç­¾åï¼š`codesign -vvv --deep --strict "åº”ç”¨.app"`

### Q3: å…¬è¯ä¸€ç›´ "In Progress"

**åŸå› ï¼š** Apple æœåŠ¡å™¨ç¹å¿™

**è§£å†³ï¼š** è€å¿ƒç­‰å¾…ï¼Œé€šå¸¸ä¸è¶…è¿‡ 15 åˆ†é’Ÿ

### Q4: ç”¨æˆ·ä»ç„¶çœ‹åˆ°å®‰å…¨è­¦å‘Š

**åŸå› ï¼š**
1. åº”ç”¨æœªå…¬è¯
2. å…¬è¯ç¥¨æ®æœªè£…è®¢
3. ç”¨æˆ·çš„ macOS ç‰ˆæœ¬å¤ªæ—§

**è§£å†³ï¼š**
1. ç¡®è®¤å…¬è¯æˆåŠŸï¼š`xcrun stapler validate "åº”ç”¨.app"`
2. ç¡®ä¿ macOS 10.15+

## ğŸ“š å‚è€ƒèµ„æ–™

- [Apple å…¬è¯æ–‡æ¡£](https://developer.apple.com/documentation/security/notarizing_macos_software_before_distribution)
- [è§£å†³å¸¸è§å…¬è¯é—®é¢˜](https://developer.apple.com/documentation/security/notarizing_macos_software_before_distribution/resolving_common_notarization_issues)
- [ä»£ç ç­¾åæŒ‡å—](https://developer.apple.com/library/archive/documentation/Security/Conceptual/CodeSigningGuide/Introduction/Introduction.html)

## ğŸ‰ æˆåŠŸæ ‡å¿—

å®Œæˆåï¼Œç”¨æˆ·ä½“éªŒåº”è¯¥æ˜¯ï¼š

1. âœ… ä¸‹è½½ DMG
2. âœ… åŒå‡»æ‰“å¼€
3. âœ… æ‹–åˆ°åº”ç”¨ç¨‹åº
4. âœ… åŒå‡»åº”ç”¨
5. âœ… **ç›´æ¥è¿è¡Œï¼Œæ— ä»»ä½•è­¦å‘Šï¼**
